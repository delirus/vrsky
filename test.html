<html>
  <head>
    <script src="aframe.min.js"></script>
  </head>
  <body>
    <a-scene id="sky">
      <!--
      <a-sphere id="gula" position="0 1 0" radius=".1" color="green"></a-sphere>
      <a-sphere id="gula" position="0 0 1" radius=".1" color="blue"></a-sphere>
      <a-box id="boxik" position="-1 0.5 -3" rotation="0 45 0" color="#4CC3D9"></a-box>
      <a-sphere id="gula" position="0 1.25 -5" radius="1.25" color="#EF2D5E"></a-sphere>
      <a-cylinder position="1 0.75 -3" radius="0.5" height="1.5" color="#FFC65D"></a-cylinder>
        <a-animation attribute="opacity" dur="5000" from="0.0" to="0.8"></a-animation>
        <a-ring position="0 0 -20" color="gray" radius="0.1" opacity=0.5></a-ring>
      --!>
      <a-camera id="camera" position="0 0 0" rotation="0 0 0"></a-camera>
      <a-sky id="starry-sky" src="milkyway.jpg"></a-sky>
      <a-sky id="black-sky" color="black" opacity="0.0"></a-sky>
    </a-scene>

    <script>
    currentDistance = 10;
    currentRotation = 0;
    
    increaseDistance = false;
    decreaseDistance = false;
    increaseRotation = false;
    decreaseRotation = false;

    function keyDownHandler(e){
        if (e.keyCode === 73) { // i
            increaseDistance = true;
        }
        else if (e.keyCode === 75) { // k
            decreaseDistance = true;
        }
        else if (e.keyCode === 74) { // j
            increaseRotation = true;
        }
        else if (e.keyCode === 76) { // l
            decreaseRotation = true;
        }
    }
    document.onkeydown=keyDownHandler;

    function keyUpHandler(e){
        if (e.keyCode === 73) { // i
            increaseDistance = false;
        }
        else if (e.keyCode === 75) { // k
            decreaseDistance = false;
        }
        else if (e.keyCode === 74) { // j
            increaseRotation = false;
        }
        else if (e.keyCode === 76) { // l
            decreaseRotation = false;
        }
        else if (e.keyCode === 13) {
            console.log(x);
            console.log(y);
            console.log(z);
            console.log(cam_d);
            console.log(cam_a);
            console.log(r);
        }
    }
    document.onkeyup=keyUpHandler;
    
    // duration of the sky darkening animation
    skyDarkeningDuration = 4000; // ms
    // duration of the sky clearing animation
    skyClearingDuration = skyDarkeningDuration / 8;
    skyDarkeningIntensity = 0.8 // level of darkening of the sky (1.0 is totally black)

    function darkenSky() {
        blackSky = document.getElementById("black-sky");
        
        // create the animation that darkens the sky
        // (animate opacity of the black sky from 0.0 to skyDarkeningIntensity)
        skyDarkening = document.createElement("a-animation");
        skyDarkening .setAttribute("id","sky-darkening");
        skyDarkening .setAttribute("attribute","opacity");
        skyDarkening .setAttribute("from","0.0");
        skyDarkening .setAttribute("to",skyDarkeningIntensity);
        skyDarkening .setAttribute("dur",skyDarkeningDuration);
        
        blackSky.appendChild(skyDarkening);
    }
    
    function clearSky() {
        skyDarkening = document.getElementById("sky-darkening");

        // if the sky darkening animation is present...
        if (skyDarkening) {
            // animate the opacity of the black sky from the current level back to 0.0
            blackSky = document.getElementById("black-sky");
            currentSkyOpacity = blackSky.getAttribute("opacity");
            
            skyClearing = document.createElement("a-animation");
            skyClearing.setAttribute("id","sky-clearing");
            skyClearing.setAttribute("attribute","opacity");
            skyClearing.setAttribute("from",currentSkyOpacity);
            skyClearing.setAttribute("to","0.0");
            // adjust the animation duration based on the current level of the darkening
            // (if the darkening was not complete, the sky will clear out faster)
            clearingDuration = skyClearningDuration*currentSkyOpacity/skyDarkeningIntensity
            skyClearing.setAttribute("dur",clearingDuration);

            blackSky.removeChild(skyDarkening);
            blackSky.appendChild(skyClearing);
            
            // delete the animation afterwards
            setTimeout(
                function(){
                    blackSky.removeChild(skyClearing);
                },
                clearingDuration);
        }
    }
    
    // changing set of the last few camera directions (direction as a unit vector)
    // in every event loop iteration the oldest direction is deleted and the current one is appended
    // (initialized with random values that are spread out over a big area to fail isGazing condition)
    previousDirections = [[1,0,0],[0,1,0],[0,0,1],[-1,0,0],[0,-1,0],[0,0,-1],
                          [1,0,0],[0,1,0],[0,0,1],[-1,0,0],[0,-1,0],[0,0,-1]];

    // if directionalVariation is bigger than this
    // then the previousDirections vectors should lie approximately within a 10 degree big patch of the sky
    defaultGazingThreshold = 0.996;
    currentGazingThreshold = defaultGazingThreshold; // may change after we zoom-in on an object

    zoomedObject = null; // is set to a JSON object with details of the currently zoomed-in object
    
    // duration of the object zoom-in animation
    zoomInDuration = 4000 // ms
    // how fast the zoomed object appears (opacity is animated from 0 to 1)
    appearDuration = zoomInDuration / 8;
    // duration of the object zoom-out animation
    zoomOutDuration = zoomInDuration / 8;

    function zoomInSkyObject(skyObject) {
        // sky object plane coordinates
        x = skyObject.x;
        y = skyObject.y;
        z = skyObject.z;
        
        skyObjectPlane = document.createElement("a-plane");
        skyObjectPlane.setAttribute("id",skyObject.id);
        skyObjectPlane.setAttribute("width",skyObject.width);
        skyObjectPlane.setAttribute("height",skyObject.height);
        skyObjectPlane.setAttribute("opacity","0.0");
        skyObjectPlane.setAttribute("transparent","true");
        skyObjectPlane.setAttribute("src",skyObject.image);
        skyObjectPlane.setAttribute("position",x+" "+y+" "+z);
        skyObjectPlane.setAttribute("rotation",skyObject.delta+" "+skyObject.alpha+" "+skyObject.orientation);
        
        objectShowAnimation = document.createElement("a-animation");
        objectShowAnimation.setAttribute("id",skyObject.id+"-show");
        objectShowAnimation.setAttribute("attribute","opacity");
        objectShowAnimation.setAttribute("from","0.0");
        objectShowAnimation.setAttribute("to","1.0");
        objectShowAnimation.setAttribute("dur",appearDuration);
        
        // fraction of distance when zoomed-in
        zoom = skyObject.zoom;
        
        objectZoomAnimation = document.createElement("a-animation");
        objectZoomAnimation.setAttribute("id",skyObject.id+"-zoom");
        objectZoomAnimation.setAttribute("attribute","position");
        objectZoomAnimation.setAttribute("from",x+" "+y+" "+z);
        objectZoomAnimation.setAttribute("to",x/zoom+" "+y/zoom+" "+z/zoom);
        objectZoomAnimation.setAttribute("dur",zoomInDuration);
        
        skyObjectPlane.appendChild(objectShowAnimation);
        skyObjectPlane.appendChild(objectZoomAnimation);

        sky = document.getElementById("sky");
        sky.appendChild(skyObjectPlane);

        currentGazingThreshold = skyObject.gazingThreshold;
    }
    
    function zoomOutSkyObject(skyObject) {
        // TODO
        // get show and zoom animations
        // remove them
        // create disappear and zoom-out animation
        // add them
        // add setTimeout to remove object after
    }
    
    function getSkyObject(gazingDirection) {
        // TODO checks and multiple objects
        return {
            id: "m31",

            image: "m31.png",

            width: 8,
            height: 8,

            x: 48.90764378515029,
            y: -45.62703952190438,
            z: 95.71002621136812,

            delta: -23.720452718416084,
            alpha: 207.0669471602788,
            orientation: -95,

            zoom: 10,

            gazingThreshold: 0.93
        }
    }
    
    function main_event_loop() {
        camera = document.querySelector('[camera]');
        if (! camera) return; // do not do anything before the VR environment is created
        
        // increase/decrease distance and rotation is set by holding down corresponding keys (i,j,k,l)
        if (increaseDistance){
            currentDistance *= 1.01; // change by 1%
        }
        if (decreaseDistance){
            currentDistance *= 0.99; // change by 1%
        }
        if (increaseRotation){
            currentRotation += 1 // change by 1 degree
        }
        if (decreaseRotation){
            currentRotation -= 1 // change by 1 degree
        }
        
        cameraRotation = camera.getAttribute('rotation');
        
        // get current camera rotational angles
        cameraDelta = cameraRotation.x;
        cameraAlpha = cameraRotation.y;
        // calculate the current camera direction as a unit vector
        currentDirection_x = -Math.sin(Math.PI * cameraAlpha / 180) * Math.cos(Math.PI * cameraDelta / 180);
        currentDirection_y =  Math.sin(Math.PI * cameraDelta / 180);
        currentDirection_z = -Math.cos(Math.PI * cameraAlpha / 180) * Math.cos(Math.PI * cameraDelta / 180);
        
        // delete the oldest recorded camera direction
        previousDirections.shift();
        // append the current camera direction
        previousDirections.push([currentDirection_x, currentDirection_y, currentDirection_z]);
        
        // keep the test plane in front of the camera if we have it
        testPlane = document.getElementById("test-plane");
        if(testPlane) {
            // put test plane in front of the camera in the currentDistance
            cameraPosition = camera.getAttribute('position');
            x = cameraPosition.x + currentDistance * direction_x;
            z = cameraPosition.z + currentDistance * direction_z;
            y = cameraPosition.y + currentDistance * direction_y;
            // keep the test plane facing the camera and rotated with currentRotation
            testPlane.setAttribute("position",x+" "+y+" "+z);
            testPlane.setAttribute("rotation",cameraDelta+" "+cameraAlpha+" "+currentRotation);
        }
        
        // average of the cosine of the angle between all of the previousDirections
        // (bigger number means that the previousDirections vectors are closer to each other)
        directionalVariation = previousDirections.reduce(
            function(s,v1){
                for(i in s[1]){
                    v2 = s[1][i];
                    s[0] += (v1[0]*v2[0] + v1[1]*v2[1] + v1[2]*v2[2]) / (s[1].length**2);
                }
                return s
            },
            [0,previousDirections]);
        
        isGazing = (directionalVariation > currentGazingThreshold);
        if (isGazing) {
            // use the average of the diretional vector of the previousDirections as the gazing direction
            gazingDirection = previousDirections.reduce(
                function(s,v){
                    s[0]+=v[0]/previousDirections.length;
                    s[1]+=v[1]/previousDirections.length;
                    s[2]+=v[2]/previousDirections.length;
                    return s;
                },
                [0,0,0]);

            // determine if there is any object near the current gazing direction
            objectUnderGaze = getSkyObject(gazingDirection);
            if (objectUnderGaze && !zoomedObject) {
                darkenSky();
                zoomInSkyObject(objectUnderGaze);
                zoomedObject = objectUnderGaze;
            }
        } else {
            // not gazing
            if (zoomedObject) {
                zoomOutSkyObject(zoomedObject);
                zoomedObject = null;
                clearSky();
            }
        }
    }
    setInterval(main_event_loop,100)
    </script>
  </body>
</html>
